<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Self Scoring</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<style>
body {
	margin-top: 7%;
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
	padding: 0.5rem;
}
.dataTables_wrapper .dataTables_info {
	padding: 0.5rem;
}
.dataTables_wrapper .dataTables_filter input {
	padding: 0.5rem;
}
.text-primary {
	color: #007bff !important;
}
.font-weight-bold {
	font-weight: bold !important;
}
#update-btn {
	background-color: black;
	color: white;
}
#jstree {
	height: 100%;
	border-right: 1px solid #ccc;
	padding: 20px;
}
#MKSOLnhanvienbadge {
	color: white;
	background-color: gray;
	font-size: small;
}
</style>
</head>
<body>
	<div class="container-fluid my-5">
		<div class="row">
			<div class="col-3">
				<div id="jstree">
					<ul>
						<li><a href="#">My OKR</a>
							<ul>
								<li><a href="crud">Create OKR</a>
									<ul>
										<li><a href="selfscoring">Self-scoring</a></li>
										<li><a href="#">Upload OKR</a></li>
									</ul></li>
								<li><a href="#">Review OKR</a></li>
							</ul></li>
						<li><a href="#">Configuration</a>
							<ul>
								<li><a href="#">Periods</a></li>
								<li><a href="#">Units</a></li>
							</ul></li>
					</ul>
				</div>
			</div>
			<div class="col-9">
				<h4 class="mb-4 font-weight-bold">
					Le Van A <span class="badge" id="MKSOLnhanvienbadge">Nhân Viên</span>
				</h4>
				<div class="d-flex justify-content-between align-items-center mb-3">
			
					<div class="form-check form-check-inline">
						<input class="form-check-input" type="checkbox" id="full-mode" value="option1"> 
						<label class="form-check-label" for="full-mode">Full mode</label> 
						<span class="ml-3 font-weight-bold" id="current-date"></span>
					</div>
				</div>
				<table id="okrs-table" class="display" style="width:100%">
					<thead>
						<tr>
							<th>No</th>
							<th>Objectives</th>
							<th>Weight</th>
							<th>Key results</th>
							<th>Unit</th>
							<th>Start value</th>
							<th>Target</th>
							<th>Self-score</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<div class="text-right mt-3">
					<!-- <button class="btn float-end" id="update-btn">Update</button> -->
					<div id="update-wrapper">
				        <button class="btn float-end" id="update-btn">Update</button>
				    </div>
				</div>
				<!-- Notification -->
				<br/>
				<br/>
				<div id="notification" class="alert alert-dismissible fade show" role="alert" style="display: none;">
				  <strong id="notification-message"></strong>
				  <!-- <button type="button" class="close" data-dismiss="alert" aria-label="Close">
				    <span aria-hidden="true">&times;</span>
				  </button> -->
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
	<script>

	$(document).ready(function() {
		var table = $('#okrs-table').DataTable({
			data: [],
			columns: [
				{ data: 'No' },
				{ data: 'Objectives' },
				{ data: 'Weight' },
				{ data: 'Key results' },
				{ data: 'Unit' },
				{ data: 'Start value' },
				{ data: 'Target' },
				{ data: 'Self-score' },
				{ data: 'KeyResultId', visible: false}
			],
			paging: true,
			searching: true,
			info: true,
			columnDefs: [
				{
					targets: '_all',
					className: 'dt-center'
				},
				{
					targets: 7, 
					render: function(data, type, row, meta) {
						if (type === 'display') {
							return `<input type="text" class="form-control form-control-sm" value="${data}">`;
						}
						return data;
					},
					className: 'editable-cell'
				}
			]
		});

		function fetchData() {
		    var url = 'objectives/loaddata';
		    var xhr = new XMLHttpRequest();
		    xhr.open('GET', url, true);
		    xhr.onreadystatechange = function() {
		        if (xhr.readyState === XMLHttpRequest.DONE) {
		            if (xhr.status === 200) {
		                var jsonResponse = JSON.parse(xhr.responseText);
		                var objectives = jsonResponse.data.objectives;
						console.log(jsonResponse);
		                objectives.sort((a, b) => {
		                    if (a.description < b.description) return -1;
		                    if (a.description > b.description) return 1;
		                    if (a.keyResults[0].description < b.keyResults[0].description) return -1;
		                    if (a.keyResults[0].description > b.keyResults[0].description) return 1;
		                    return 0;
		                });

		                var datalayout = [];
		                objectives.forEach(function(objective, objectiveIndex) {
		                    objective.keyResults.forEach(function(keyResult, krIndex) {
		                        var unit;
		                        switch (keyResult.itype) {
		                            case 1:
		                                unit = 'Number';
		                                break;
		                            case 2:
		                                unit = 'Yes/No';
		                                break;
		                            case 3:
		                                unit = 'Percentage';
		                                break;
		                            default:
		                                unit = '';
		                                break;
		                        }

		                        datalayout.push({
		                            No: krIndex === 0 ? (objectiveIndex + 1) : '',
		                            Objectives: objective.description,
		                            Weight: objective.weight,
		                            "Key results": keyResult.description,
		                            Unit: unit,
		                            "Start value": keyResult.startvalue,
		                            Target: keyResult.target,
		                            "Self-score": keyResult.finalScore,
		                            KeyResultId: keyResult.keyResultId
		                        });
		                    });
		                });

		                table.clear().rows.add(datalayout).draw();
		            } else {
		                console.error('Failed to fetch data. Status:', xhr.status);
		            }
		        }
		    };
		    xhr.send();
		}
		
		function submitData() {
		    var data = table.rows().data().toArray();
		    var totalRequests = data.length; 
		    var successfulRequests = 0; // Check for notification.
		    var failedRequests = 0; // Check for notification,
		    
		    data.forEach(function(row){
		        var keyResultId = row["KeyResultId"];
		        var self_score = row["Self-score"];
		        
		        var data = {
		            finalScore: self_score
		        };
		        var payload = JSON.stringify(data);
		        
		        var url = `update/selfscore/${keyResultId}`;
		        
		        $.ajax({
					url: url,
					type: 'POST',
					contentType: 'application/json',
					data: payload,
					success: function(response) {
						console.log('Data saved successfully:', response);
						successfulRequests++;
						checkCompletion();
					},
					error: function(xhr, status, error) {
						console.error('Error saving data:', {
						      status: xhr.status,
						      statusText: xhr.statusText,
						      responseText: xhr.responseText
						    });
						failedRequests++;
						checkCompletion();
					}
				});
		    });
		    function checkCompletion() {
		        if (successfulRequests + failedRequests === totalRequests) {
		            var message = failedRequests === 0 ? 'Thành công!' : 'Thất bại!';
		            $('#notification-message').text(message);
		            $('#notification').addClass('alert-success').removeClass('alert-danger');
		            if (failedRequests > 0) {
		                $('#notification').addClass('alert-danger').removeClass('alert-success');
		            }
		            $('#notification').show();
		        }
		    }

		}

		fetchData();

		$('#jstree').jstree({
			'core' : {
				'themes' : {
					'name' : 'default',
					'responsive' : true
				}
			}
		});


		$('#full-mode').on('change', function() {
			var newWidth = $(this).is(':checked') ? 200 : 150;
			$('#okrs-table').DataTable().columns().every(function() {
				this.header().style.width = newWidth + 'px';
			});
		});

		$('#update-btn').on('click', function() {
			submitData();
		});

		$('#okrs-table').on('change', 'input', function() {
			var cell = $(this).closest('td');
			var rowIndex = table.cell(cell).index().row;
			var columnIndex = table.cell(cell).index().column;
			var newValue = $(this).val();
			
			table.cell(rowIndex, columnIndex).data(newValue).draw();
		});

		$('#jstree').on('click', 'a[href="crud"]', function() {
			window.location.href = 'crud';
		});

		var currentDate = new Date().toLocaleDateString('vi-VN', {
			year : 'numeric',
			month : 'long',
			day : 'numeric'
		});
		$('#current-date').text(currentDate);
	});
	</script>
</body>
</html>
