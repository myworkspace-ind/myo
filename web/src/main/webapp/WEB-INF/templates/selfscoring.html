<style>
body {
	background-color: #1f2225;
	color: white;
	margin-top: 7%;
}

#okrs-table {
	background-color: #1f2225;
}

.dt-center {
	background-color: #1f2225;
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
	padding: 0.5rem;
}

.dataTables_wrapper .dataTables_info {
	padding: 0.5rem;
}

.dataTables_wrapper .dataTables_filter input {
	padding: 0.5rem;
	color: black; /* Ensure input text is readable */
}

.text-primary {
	color: #007bff !important;
}

.font-weight-bold {
	font-weight: bold !important;
}

#update-btn {
	background-color: black;
	color: white;
}

#jstree {
	height: 100%;
	border-right: 1px solid #ccc;
	padding: 20px;
}

table.dataTable tbody tr:nth-child(odd) {
	background-color: #2c3035;
}

table.dataTable tbody tr:nth-child(even) {
	background-color: #1f2225;
}

#MKSOLnhanvienbadge {
	color: white;
	background-color: gray;
	font-size: small;
}

.form-control {
	background-color: #1f2225;
	color: white;
}

.sorting_1 {
	background-color: #1f2225 !important;
}
</style>
<div class="container-fluid my-5">
	<div class="row">
		<div class="col-9">
			<h4 class="mb-4 font-weight-bold">
				Le Van A <span class="badge" id="MKSOLnhanvienbadge">Nhân
					Viên</span>
			</h4>
			<div class="d-flex justify-content-between align-items-center mb-3">
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="checkbox" id="full-mode"
						value="option1"> <label class="form-check-label"
						for="full-mode">Full mode</label> <span
						class="ml-3 font-weight-bold" id="current-date"></span>
				</div>
			</div>
			<table id="okrs-table" class="display" style="width: 100%">
				<thead>
					<tr>
						<th>No</th>
						<th>Objectives</th>
						<th>Weight</th>
						<th>Key results</th>
						<th>Unit</th>
						<th>Start value</th>
						<th>Target</th>
						<th>Self-score</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			<div class="text-right mt-3">
				<div id="update-wrapper">
					<button class="btn float-end" id="update-btn">Update</button>
				</div>
			</div>
			<!-- Notification -->
			<br /> <br />
			<div id="notification" class="alert alert-dismissible fade show"
				role="alert" style="display: none;">
				<strong id="notification-message"></strong>
			</div>
		</div>
	</div>
</div>
<script>
    $(document).ready(function() {
        var table = $('#okrs-table').DataTable({
            data: [],
            columns: [
                { data: 'No' },
                { data: 'Objectives' },
                { data: 'Weight' },
                { data: 'Key results' },
                { data: 'Unit' },
                { data: 'Start value' },
                { data: 'Target' },
                { data: 'Self-score' },
                { data: 'KeyResultId', visible: false }
            ],
            paging: true,
            searching: true,
            info: true,
            columnDefs: [
                {
                    targets: '_all',
                    className: 'dt-center'
                },
                {
                    targets: 7,
                    render: function(data, type, row, meta) {
                        if (type === 'display') {
                            return `<input type="text" class="form-control form-control-sm" value="${data}">`;
                        }
                        return data;
                    },
                    className: 'editable-cell'
                }
            ]
        });

        function fetchData() {
            var url = 'objectives/loaddata';
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var jsonResponse = JSON.parse(xhr.responseText);
                        var objectives = jsonResponse.data.objectives;
                        console.log(jsonResponse);
                        objectives.sort((a, b) => {
                            if (a.description < b.description) return -1;
                            if (a.description > b.description) return 1;
                            if (a.keyResults[0].description < b.keyResults[0].description) return -1;
                            if (a.keyResults[0].description > b.keyResults[0].description) return 1;
                            return 0;
                        });

                        var datalayout = [];
                        objectives.forEach(function(objective, objectiveIndex) {
                            objective.keyResults.forEach(function(keyResult, krIndex) {
                                var unit;
                                switch (keyResult.itype) {
                                    case 1:
                                        unit = 'Number';
                                        break;
                                    case 2:
                                        unit = 'Yes/No';
                                        break;
                                    case 3:
                                        unit = 'Percentage';
                                        break;
                                    default:
                                        unit = '';
                                        break;
                                }

                                datalayout.push({
                                    No: krIndex === 0 ? (objectiveIndex + 1) : '',
                                    Objectives: objective.description,
                                    Weight: objective.weight,
                                    "Key results": keyResult.description,
                                    Unit: unit,
                                    "Start value": keyResult.startvalue,
                                    Target: keyResult.target,
                                    "Self-score": keyResult.finalScore,
                                    KeyResultId: keyResult.keyResultId
                                });
                            });
                        });

                        table.clear().rows.add(datalayout).draw();
                    } else {
                        console.error('Failed to fetch data. Status:', xhr.status);
                    }
                }
            };
            xhr.send();
        }
        
        function submitData() {
            var data = table.rows().data().toArray();
            var totalRequests = data.length; 
            var successfulRequests = 0; 
            var failedRequests = 0; 
            
            data.forEach(function(row){
                var keyResultId = row["KeyResultId"];
                var self_score = row["Self-score"];
                
                var data = {
                    finalScore: self_score
                };
                var payload = JSON.stringify(data);
                
                var url = `update/selfscore/${keyResultId}`;
                
                $.ajax({
                    url: url,
                    type: 'POST',
                    contentType: 'application/json',
                    data: payload,
                    success: function(response) {
                        console.log('Data saved successfully:', response);
                        successfulRequests++;
                        checkCompletion();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error saving data:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText
                        });
                        failedRequests++;
                        checkCompletion();
                    }
                });
            });

            function checkCompletion() {
                if (successfulRequests + failedRequests === totalRequests) {
                    var message = failedRequests === 0 ? 'Thành công!' : 'Thất bại!';
                    $('#notification-message').text(message);
                    $('#notification').addClass('alert-success').removeClass('alert-danger');
                    if (failedRequests > 0) {
                        $('#notification').addClass('alert-danger').removeClass('alert-success');
                    }
                    $('#notification').show();
                }
            }
        }

        fetchData();


        $('#full-mode').on('change', function() {
            var newWidth = $(this).is(':checked') ? 200 : 150;
            $('#okrs-table').DataTable().columns().every(function() {
                this.header().style.width = newWidth + 'px';
            });
        });

        $('#update-btn').on('click', function() {
            submitData();
        });

        $('#okrs-table').on('change', 'input', function() {
            var cell = $(this).closest('td');
            var rowIndex = table.cell(cell).index().row;
            var columnIndex = table.cell(cell).index().column;
            var newValue = $(this).val();
            
            table.cell(rowIndex, columnIndex).data(newValue).draw();
        });

      

        var currentDate = new Date().toLocaleDateString('vi-VN', {
            year : 'numeric',
            month : 'long',
            day : 'numeric'
        });
        $('#current-date').text(currentDate);
    });
    </script>
